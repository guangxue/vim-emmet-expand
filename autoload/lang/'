let s:pat_str ='\zs\S.\+\S\ze' 

function! s:uncomment_lines(startline, endline)
    let startline = getline(a:startline)
    let uncommented_startline = substitute(startline, '<!-- ', '', 'g')
    let endline = getline(a:endline)
    let uncommented_endline = substitute(endline, ' -->', '', 'g')
    return [uncommented_startline, uncommented_endline]
endfun

function! s:comment_lines(startline, endline)
    if a:startline == a:endline
        let curline = getline(a:startline)
        let curlinestr = matchstr(curline, s:pat_str)
        let commented_curline = substitute(curline, s:pat_str, '<!-- '.curlinestr.' -->', 'g')
        return commented_curline
    endif

    let startline = getline(a:startline)
    let startlinestr = matchstr(startline, s:pat_str)
    let commented_startline = substitute(startline, s:pat_str, '<!-- '.startlinestr, 'g')
    
    let endline = getline(a:endline)
    let endlinestr = matchstr(endline, s:pat_str)
    let commented_endline = substitute(endline, s:pat_str, endlinestr.' -->', 'g')

    return [commented_startline, commented_endline]
endfun

function! s:has_outer_uncomment_done()
    let clnum = line('.')
    let [startlnum, endlnum] = str#outersearchrange('<!--', '-->')
    echom "%% outer search range:"
    echom "%% startlnum ->".startlnum
    echom "%% endlnum ->".endlnum
    if endlnum > clnum
        if startlnum < clnum
            let [uncm_startline, uncm_endline] = s:uncomment_lines(startlnum, endlnum)
            call setline(startlnum, uncm_startline)
            call setline(endlnum, uncm_endline)
            return 1
        endif
    endif
    return ''
endfun

function! s:uncomment_inner(startlnum, endlnum)
    for i in range(a:startlnum, a:endlnum)
        let currentl = getline(i)
        if currentl =~ '<!--'
            let currl = substitute(currentl, '<!-- ', '', 'g')
            call setline(i, currl)
            return ''
        endif
        if currentl =~ '-->'
            let currl = substitute(currentl, ' -->', '', 'g')
            call setline(i, currl)
            return ''
        endif
	endfor
    return ''
endfun

function! s:comment_tagfrom(tag) abort
    let clnum = line('.')

    if a:tag == 'open'
        echom '# comment open tag <>'
        "let endlnum = str#endlnum_for('<\w\+','</\w\+>')
        let [startlnum, endlnum] = str#searchrange('<\w\+','</\w\+>')
        if endlnum != 0
            call s:uncomment_inner(clnum, endlnum-1)
            " if has outer uncommented tag, uncomment it and do nothing.
            if !s:has_outer_uncomment_done()
                if endlnum > clnum
                    "let startlnum = str#startlnum_for('<\w\+','</\w\+>')
                    let [cm_startl, cm_endl] = s:comment_lines(startlnum, endlnum)
                    let startls = getline(startlnum)->matchstr(s:pat_str)
                    if getline(startlnum)->matchstr(s:pat_str) =~ '<!--'
                        let [uncm_startl, uncm_endl] = uncomment_lines(startlnum, endlnum)
                        call setline(startlnum, uncm_startl)
                        call setline(endlnum, uncm_endl)
                        return ''
                    else
                        call setline(startlnum, cm_startl)
                        call setline(endlnum, cm_endl)
                        return ''
                    endif
                endif
                if endlnum == clnum
                    let cm_curline = s:comment_lines(clnum, clnum)
                    call setline(clnum, cm_curline)
                    return ''
                endif
            endif
        endif
        return ''
    endif

    if a:tag == 'close'
        echom '# comment close tag </>'
        let [startlnum, endlnum] = str#searchrange('<\w\+', '</\w\+>')
        echom '# startlnum ->'.startlnum
        echom '# endlnum ->'.endlnum
        if startlnum != 0
            call s:uncomment_inner(startlnum, endlnum)
            if !s:has_outer_uncomment_done()
                if startlnum < clnum
                    let [cm_startl, cm_endl] = s:comment_lines(startlnum, endlnum)
                    call setline(startlnum, cm_startl)
                    call setline(endlnum, cm_endl)
                    return ''
                endif
            endif
        endif
        return ''
    endif
endf

function! s:uncomment_tags()
    echom "&& uncomment opentag"
    let [startlnum, endlnum] = str#searchrange('<!--', '-->')
    echom "&& startlnum ->".startlnum
    echom "&& endlnum ->".endlnum 
    let [uncm_startlnum, uncm_endlnum] = s:uncomment_lines(startlnum, endlnum)
    call setline(startlnum, uncm_startlnum)
    call setline(endlnum, uncm_endlnum)
    return ''
endf

function! lang#html#toggle_comment()
    let clinestr = getline('.')->matchstr(s:pat_str)
    if clinestr =~ '^<!--' || clinestr =~ '-->'
        return s:uncomment_tags()
    endif

    let open_tag = matchstr(clinestr, '\(<\)\@<=\w\+')
    if !empty(open_tag)
        return s:comment_tagfrom('open')
	endif
    if empty(open_tag)
        return s:comment_tagfrom('close')
    endif
endf
